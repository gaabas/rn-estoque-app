<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RIN – Checagem de Estoque</title>
  
  <!-- Opcional, mas recomendado: Adicione um ícone na pasta do seu projeto e descomente a linha abaixo -->
  <!-- <link rel="icon" type="image/x-icon" href="/favicon.ico"> -->

  <!-- ================================== CSS ATUALIZADO ================================== -->
  <style>
    /* ===== Tema claro ===== */
    :root{
      --bg:#f8fafc; /* Levemente mais claro */
      --text:#0f172a;
      --muted:#475569;
      --card:#fff;
      --border:#e2e8f0;
      --shadow:0 6px 20px rgba(2,6,23,.06);
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:14px;
      --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.4); /* Anel de foco acessível */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent; /* Remove o destaque cinza no clique em iOS */
      overscroll-behavior: none; /* Previne pull-to-refresh em mobile */
    }

    /* ===== Header ===== */
    header{
      position:sticky;top:0;z-index:10;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      box-shadow:var(--shadow); /* Adiciona sombra para flutuar */
    }
    .header-wrap{
      display:grid;
      gap:8px;
      grid-template-columns:1fr auto;
      max-width:1200px; /* Limita largura em telas grandes */
      margin:0 auto;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 12px;border-radius:10px;
      background:#fff;border:1px solid var(--border);
      cursor:pointer;
      transition:background .2s, border-color .2s;
    }
    .tab.active{
      background:#e0e7ff; /* Cor mais forte para ativo */
      border-color:#a5b4fc;
      color:#312e81; /* Texto mais escuro */
      font-weight:600;
    }
    .tab:hover:not(.active){background:#f1f5f9;}
    .tab:focus-visible{outline:2px solid var(--focus-ring); outline-offset:2px;}

    .toolbar{
      display:flex; /* Usar flexbox para melhor controle em responsividade */
      flex-wrap:wrap; /* Permite quebrar linha */
      gap:8px;
      align-items:center;
      justify-content: flex-end; /* Alinha à direita por padrão */
    }
    .toolbar input, .toolbar select, .toolbar button{
      background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;
      font-size:1rem; /* Garante tamanho de fonte consistente */
      transition:border-color .2s, background .2s, box-shadow .2s;
    }
    .toolbar input:focus-visible, .toolbar select:focus-visible, .toolbar button:focus-visible{
      outline:none;
      border-color:#6366f1;
      box-shadow:var(--focus-ring);
    }
    .toolbar button{cursor:pointer;}
    .toolbar button.ghost{background:#f8fafc;} /* fundo mais claro */
    .toolbar button.ghost:hover{background:#f1f5f9;}

    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f1f5f9;display:none}

    /* ===== Conteúdo ===== */
    .container{
      padding:12px 12px 96px; /* padding-bottom evita ficar atrás do rodapé */
      max-width:1200px; /* Limita largura em telas grandes */
      margin:0 auto;
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);padding:12px;
      display:flex;flex-direction:column;gap:8px;
      box-shadow:var(--shadow);
      transition:box-shadow .2s;
    }
    .card:hover{box-shadow:0 8px 25px rgba(2,6,23,.08);}

    .name{font-weight:700}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .status{
      display:flex;
      gap:6px;
      justify-content: flex-end; /* Alinha o pill à direita */
      margin-top: 8px; /* Adiciona espaço acima do pill */
    }
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid transparent;
      cursor:pointer; /* Indica que é clicável */
      transition:background .2s, border-color .2s, transform .1s;
    }
    .pill:hover{transform: translateY(-1px);} /* Efeito de leve elevação */
    .pill:active{transform: translateY(0); box-shadow: inset 0 1px 3px rgba(0,0,0,.1);} /* Efeito de clique */
    .pill:focus-visible{outline:none; border-color:#6366f1; box-shadow:var(--focus-ring);}

    .pill.ok{background:rgba(22,163,74,.10);border-color:#86efac;color:#065f46}
    .pill.warn{background:rgba(217,119,6,.12);border-color:#fed7aa;color:#7c2d12}
    .pill.bad{background:rgba(220,38,38,.10);border-color:#fecaca;color:#7f1d1d}

    .btnbar { display: none; }

    button{
      cursor:pointer;border-radius:10px;border:1px solid var(--border);
      background:#f8fafc;color:var(--text);padding:8px 10px;
      font-size:1rem; /* Garante tamanho de fonte consistente */
      transition:background .2s, border-color .2s, box-shadow .2s;
    }
    button:hover{background:#f1f5f9;}
    button:active{transform: translateY(1px); box-shadow: inset 0 1px 3px rgba(0,0,0,.1);}
    button:focus-visible{outline:none; border-color:#6366f1; box-shadow:var(--focus-ring);}

    button.primary{background:#e0e7ff;border-color:#c7d2fe;color:#312e81; font-weight:600;}
    button.primary:hover{background:#c7d2fe;}
    button.ghost{background:transparent;} /* Fundo transparente */
    button.ghost:hover{background:#f1f5f9;}


    .empty{color:#64748b;font-style:italic;padding:24px 0; text-align:center;}

    /* ===== Rodapé ===== */
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid var(--border);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      display:flex;
      gap:8px;
      justify-content:flex-end;
      box-shadow:0 -6px 20px rgba(2,6,23,.06); /* Adiciona sombra para flutuar */
      flex-wrap: wrap; /* Permite que os botões quebrem linha */
    }
    .footerbar button{
      flex-shrink: 0; /* Evita que os botões encolham */
    }


    /* ===== Gestor form ===== */
    form.add-item{
      display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px;margin:8px 0 16px;
      padding:12px; /* Adiciona padding para parecer mais com um card */
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    form.add-item input{
      background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;
      font-size:1rem;
      transition:border-color .2s, box-shadow .2s;
    }
    form.add-item input:focus-visible{
      outline:none;
      border-color:#6366f1;
      box-shadow:var(--focus-ring);
    }

    /* ===== Responsivo ===== */
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    }
    @media (max-width:640px){
      .header-wrap{
        grid-template-columns:1fr; /* Tabs no topo, toolbar abaixo */
      }
      .toolbar{
        flex-direction: column; /* Empilha os itens verticalmente */
        align-items: stretch; /* Estica os itens para preencher a largura */
      }
      .toolbar input, .toolbar select, .toolbar .admin {
        width: 100%; /* Ocupa a largura total disponível */
      }
      .toolbar .admin button {
        width: 100%;
      }
      #search{order: -1;} /* Coloca a busca no topo da toolbar */

      .grid{grid-template-columns:1fr}

      .footerbar{
        display:grid; /* Mudar para grid para empilhar */
        grid-template-columns:1fr; /* Uma coluna, todos empilhados */
        gap:8px;
        justify-content: unset; /* Desfaz o justify-content flexbox */
      }
      .footerbar button{
        width: 100%; /* Cada botão ocupa a largura total */
      }

      form.add-item{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-wrap">
      <div class="tabs">
        <button class="tab active" data-view="producao">Produção</button>
        <button class="tab" data-view="compras">Compras</button>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Buscar item…" />
        <select id="filter">
          <option value="TODOS">Todos</option>
          <option value="OK">OK</option>
          <option value="ALERTA">⚠ alerta</option>
          <option value="FALTA">❌ falta</option>
        </select>
        <button id="refresh" class="ghost">Recarregar</button>
        <div class="admin">
          <span id="adminBadge" class="badge">Gestor</span>
          <button id="adminBtn" class="ghost">Entrar como Gestor</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <form class="add-item" id="addForm" style="display:none">
      <input id="nome" placeholder="Nome do item" />
      <input id="categoria" placeholder="Categoria" />
      <input id="unidade" placeholder="Unidade (kg, un, pct…)" />
      <input id="parMin" type="number" min="0" placeholder="Par mín." />
      <button type="submit" class="primary">Adicionar</button>
    </form>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Nenhum item encontrado.</div>
  </div>

  <div class="footerbar">
    <button id="exportCsv" class="ghost">Exportar CSV (lista de compras)</button>
    <button id="markOk">Marcar selecionados como OK</button>
    <button id="markWarn">Marcar selecionados como ⚠ Alerta</button>
    <button id="markBad">Marcar selecionados como ❌ Falta</button>
    <button id="save" class="primary">Salvar alterações</button>
  </div>

  <!-- ================================== JAVASCRIPT ATUALIZADO ================================== -->
  <script type="module">
    // app.js — RIN v2 (Supabase) — Tema Claro + Modo Gestor + Exportar CSV (Otimizado para Mobile)
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ====== CONFIG ================================================================================
    const SUPABASE_URL = 'https://slrjqqzzxxpywquphvjz.supabase.co'; // MANTENHA O SEU
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscmpxcXp6eHhweXdxdXBodmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTYyMjksImV4cCI6MjA3MDI3MjIyOX0.JuzZMOC2X4NQUXeVdYBoQDY5pN-2O2igPK0zjNdcjcU'; // MANTENHA A SUA
    const GESTOR_PIN = '3461'; // MANTENHA O SEU

    export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== ESTADO ================================================================================
    let currentView = 'producao';
    let allItems = [];
    let filtered = [];
    let staged = new Map();
    let selected = new Set();
    let isGestor = !!localStorage.getItem('rin_is_gestor');

    // ====== ELEMENTOS =============================================================================
    const $tabs = document.querySelectorAll('.tab');
    const $search = document.getElementById('search');
    const $filter = document.getElementById('filter');
    const $refresh = document.getElementById('refresh');
    const $list = document.getElementById('list');
    const $empty = document.getElementById('empty');
    const $addForm = document.getElementById('addForm');
    const $nome = document.getElementById('nome');
    const $categoria = document.getElementById('categoria');
    const $unidade = document.getElementById('unidade');
    const $parMin = document.getElementById('parMin');
    const $markOk = document.getElementById('markOk');
    const $markWarn = document.getElementById('markWarn');
    const $markBad = document.getElementById('markBad');
    const $save = document.getElementById('save');
    const $exportCsv = document.getElementById('exportCsv');
    const $adminBtn = document.getElementById('adminBtn');
    const $adminBadge = document.getElementById('adminBadge');

    // ====== HELPERS ===============================================================================
    const statusToEmoji = (s) => {
      switch (s) {
        case 'OK': return { label: 'OK', cls: 'ok', next: 'ALERTA' };
        case 'ALERTA': return { label: '⚠ Alerta', cls: 'warn', next: 'FALTA' };
        case 'FALTA': return { label: '❌ Falta', cls: 'bad', next: 'OK' };
        default: return { label: s, cls: '', next: 'OK' };
      }
    };

    function normalize(str) {
      return (str || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function notify(msg) {
      const n = document.createElement('div');
      n.textContent = msg;
      n.style.position = 'fixed';
      n.style.right = '16px';
      n.style.bottom = '80px'; // Subi um pouco para não ficar em cima do rodapé no mobile
      n.style.background = '#111827';
      n.style.color = '#f8fafc';
      n.style.border = '1px solid #1f2937';
      n.style.borderRadius = '10px';
      n.style.padding = '8px 12px';
      n.style.boxShadow = '0 6px 20px rgba(0,0,0,.20)';
      n.style.zIndex = '9999';
      n.style.opacity = '0';
      n.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
      n.style.transform = 'translateY(10px)';
      document.body.appendChild(n);
      
      requestAnimationFrame(() => {
        n.style.opacity = '1';
        n.style.transform = 'translateY(0)';
      });

      setTimeout(() => {
        n.style.opacity = '0';
        n.style.transform = 'translateY(10px)';
        setTimeout(() => n.remove(), 300);
      }, 2000);
    }

    function updateSaveButton() {
      const n = staged.size;
      $save.textContent = n ? `Salvar alterações (${n})` : 'Salvar alterações';
      $save.disabled = n === 0;
    }

    function updateGestorUI() {
      if ($addForm) $addForm.style.display = isGestor ? 'grid' : 'none';
      if ($adminBadge) $adminBadge.style.display = isGestor ? 'inline-block' : 'none';
      if ($adminBtn) $adminBtn.textContent = isGestor ? 'Sair do modo Gestor' : 'Entrar como Gestor';
    }

    function applyFilters() {
      const q = normalize($search?.value);
      const f = $filter?.value || 'TODOS';
      let rows = allItems.slice();
      if (currentView === 'compras') {
        rows = rows.filter(r => (staged.get(r.id)?.status || r.status) !== 'OK');
      }
      if (f !== 'TODOS') {
        rows = rows.filter(r => (staged.get(r.id)?.status || r.status) === f);
      }
      if (q) {
        rows = rows.filter(r =>
          normalize(r.nome).includes(q) ||
          normalize(r.categoria).includes(q) ||
          normalize(r.unidade).includes(q)
        );
      }
      filtered = rows;
    }

    function render() {
      applyFilters();
      $list.innerHTML = '';
      if (filtered.length === 0) {
        $empty.style.display = 'block';
        return;
      }
      $empty.style.display = 'none';

      for (const item of filtered) {
        const effectiveStatus = staged.get(item.id)?.status || item.status;
        const s = statusToEmoji(effectiveStatus);
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = item.id;
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.nome;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = selected.has(item.id);
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) selected.add(item.id);
          else selected.delete(item.id);
          card.style.borderColor = e.target.checked ? '#a5b4fc' : '';
        });
        header.appendChild(name);
        header.appendChild(checkbox);
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <span>${item.categoria || '–'}</span>
          <span>•</span>
          <span>${item.unidade || '–'}</span>
          <span>•</span>
          <span>par mín.: ${item.parMin ?? '–'}</span>
        `;
        const statusRow = document.createElement('div');
        statusRow.className = 'status';
        const pill = document.createElement('span');
        pill.className = `pill ${s.cls}`;
        pill.textContent = s.label;
        pill.tabIndex = 0; // Torna o pill focável com o teclado
        pill.addEventListener('click', () => {
          const currentStatus = staged.get(item.id)?.status || item.status;
          const nextStatus = statusToEmoji(currentStatus).next;
          stageStatus(item.id, nextStatus);
        });
        pill.addEventListener('keydown', (e) => { // Permite mudar com Enter/Espaço
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            pill.click();
          }
        });
        statusRow.appendChild(pill);
        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(statusRow);
        $list.appendChild(card);
      }
    }

    function stageStatus(id, status) {
      const current = staged.get(id) || {};
      staged.set(id, { ...current, status });
      updateSaveButton();
      render();
    }

    function bulkStage(status) {
      if (selected.size === 0) {
        notify('Nenhum item selecionado!');
        return;
      }
      for (const id of selected) stageStatus(id, status);
      updateSaveButton();
    }

    async function fetchItems() {
      const { data, error } = await supabase.from('itens').select('*').order('nome', { ascending: true });
      if (error) {
        console.error('Erro ao carregar itens:', error);
        notify('Erro ao carregar itens.');
        return;
      }
      allItems = data || [];
      render();
    }

    async function addItem(payload) {
      const { data, error } = await supabase.from('itens').insert([payload]).select().single();
      if (error) {
        console.error('Erro ao adicionar item:', error);
        alert('Não consegui adicionar o item. Veja o console.');
        return null;
      }
      allItems.push(data);
      allItems.sort((a,b)=> a.nome.localeCompare(b.nome));
      render();
      notify('Item adicionado!');
      return data;
    }

    async function saveStaged() {
      if (staged.size === 0) return;
      $save.disabled = true;
      const originalLabel = $save.textContent;
      $save.textContent = 'Salvando…';
      try {
        const ops = [];
        for (const [id, patch] of staged.entries()) {
          ops.push(supabase.from('itens').update(patch).eq('id', id));
        }
        await Promise.all(ops);
        await fetchItems();
        staged.clear();
        selected.clear();
        notify('Alterações salvas');
      } catch (e) {
        console.error('Erro inesperado no save:', e);
        alert('Erro inesperado ao salvar. Veja o console.');
      } finally {
        updateSaveButton();
      }
    }
    
    function toCsv(rows) {
      const header = ['nome','categoria','unidade','parMin','status'];
      const esc = (v) => {
        const s = v == null ? '' : String(v);
        return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };
      const lines = [header.join(';')];
      for (const r of rows) {
        const status = staged.get(r.id)?.status || r.status;
        lines.push([r.nome, r.categoria || '', r.unidade || '', r.parMin ?? '', status].map(esc).join(';'));
      }
      return lines.join('\n');
    }
    
    function download(filename, text) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function exportCsv() {
      let rows;
      if (currentView === 'compras') {
        rows = filtered.slice();
      } else {
        rows = (allItems).filter(r => (staged.get(r.id)?.status || r.status) !== 'OK');
      }
      if (!rows.length) { notify('Nada para exportar'); return; }
      const csv = toCsv(rows);
      const stamp = new Date().toISOString().slice(0,10);
      download(`lista-compras-${stamp}.csv`, csv);
      notify('CSV gerado');
    }

    $tabs.forEach(tab => tab.addEventListener('click', () => {
      $tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentView = tab.dataset.view;
      render();
    }));

    $search?.addEventListener('input', render);
    $filter?.addEventListener('change', render);
    $refresh?.addEventListener('click', fetchItems);
    $markOk.addEventListener('click', () => bulkStage('OK'));
    $markWarn.addEventListener('click', () => bulkStage('ALERTA'));
    $markBad.addEventListener('click', () => bulkStage('FALTA'));
    $save.addEventListener('click', saveStaged);
    $exportCsv.addEventListener('click', exportCsv);

    $addForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isGestor) return;
      const payload = {
        nome: ($nome.value || '').trim(),
        categoria: ($categoria.value || '').trim() || null,
        unidade: ($unidade.value || '').trim() || null,
        parMin: $parMin.value ? Number($parMin.value) : null,
        status: 'OK'
      };
      if (!payload.nome) { notify('O nome do item é obrigatório!'); $nome.focus(); return; }
      await addItem(payload);
      $addForm.reset();
      $nome.focus();
    });

    $adminBtn?.addEventListener('click', () => {
      if (isGestor) {
        isGestor = false;
        localStorage.removeItem('rin_is_gestor');
        updateGestorUI();
        notify('Saiu do modo Gestor');
        return;
      }
      const pin = prompt('PIN do Gestor:');
      if (pin === GESTOR_PIN) {
        isGestor = true;
        localStorage.setItem('rin_is_gestor', '1');
        updateGestorUI();
        notify('Modo Gestor ativado');
      } else if (pin !== null) {
        alert('PIN incorreto.');
      }
    });

    updateGestorUI();
    updateSaveButton();
    fetchItems();
  </script>
</body>
</html>
