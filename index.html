<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RIN ‚Äì Checagem de Estoque</title>
  
  <!-- ================================== CSS ATUALIZADO ================================== -->
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#475569;
      --card:#fff; --border:#e2e8f0; --shadow:0 6px 20px rgba(2,6,23,.06);
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:14px; --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.4);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Header (AGORA COM AUTO-HIDE) ===== */
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,0.85); /* Fundo semi-transparente */
      backdrop-filter: blur(8px); /* Efeito de vidro fosco */
      -webkit-backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border); padding:10px 12px;
      transition: transform 0.3s ease-in-out; /* ANIMA√á√ÉO DE ENTRADA/SA√çDA */
    }
    /* CLASSE PARA ESCONDER O HEADER */
    header.hidden {
      transform: translateY(-100%);
    }
    .header-wrap{
      display:grid; gap:8px; grid-template-columns:auto 1fr;
      max-width:1200px; margin:0 auto; align-items: center;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 12px;border-radius:10px; background:#fff;border:1px solid var(--border);
      cursor:pointer; transition:background .2s, border-color .2s;
    }
    .tab.active{
      background:#e0e7ff; border-color:#a5b4fc; color:#312e81; font-weight:600;
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content: flex-end;
    }
    .toolbar input, .toolbar select, .toolbar button{
      background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;
      font-size:1rem; transition:border-color .2s, box-shadow .2s;
    }
    .toolbar button.icon-btn { /* Estilo para o novo bot√£o de exportar */
        padding: 8px;
        line-height: 1;
        font-size: 1.2rem;
    }

    /* ===== Conte√∫do ===== */
    .container{
      padding:12px 12px 24px; /* Padding inferior reduzido, pois o footer some */
      max-width:1200px; margin:0 auto;
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);padding:12px;
      display:flex;flex-direction:column;gap:8px; box-shadow:var(--shadow);
    }
    .card.selected { /* Destaque visual para cards selecionados */
        border-color: #a5b4fc;
        box-shadow: 0 0 0 2px #a5b4fc;
    }
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
    .status{display:flex; justify-content: flex-end; margin-top: 8px;}
    .pill{
      padding:6px 12px;border-radius:999px;font-size:12px; border:1px solid transparent;
      cursor:pointer; transition:all .2s;
    }
    .pill.ok{background:rgba(22,163,74,.10);border-color:#86efac;color:#065f46}
    .pill.warn{background:rgba(217,119,6,.12);border-color:#fed7aa;color:#7c2d12}
    .pill.bad{background:rgba(220,38,38,.10);border-color:#fecaca;color:#7f1d1d}

    /* ===== Rodap√© (AGORA CONDICIONAL) ===== */
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index: 20;
      background:rgba(255,255,255,0.85);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      box-shadow:0 -6px 20px rgba(2,6,23,.06);
      transition: transform 0.3s ease-in-out; /* ANIMA√á√ÉO DE ENTRADA/SA√çDA */
      display:grid; grid-template-columns:1fr; gap:8px;
    }
    /* CLASSE PARA ESCONDER O RODAP√â */
    .footerbar.hidden {
        transform: translateY(100%);
    }
    .footerbar button{ width: 100%; }

    /* Outros estilos permanecem os mesmos */
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f1f5f9;display:none}
    .empty{color:#64748b;font-style:italic;padding:24px 0; text-align:center;}
    button{cursor:pointer;border-radius:10px;border:1px solid var(--border);background:#f8fafc;color:var(--text);padding:8px 10px;font-size:1rem;}
    button.primary{background:#e0e7ff;border-color:#c7d2fe;color:#312e81; font-weight:600;}
    form.add-item{display:grid;gap:8px;margin:8px 0 16px;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    form.add-item input{background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem;}

    /* ===== Media Queries ===== */
    @media (min-width: 641px) { /* Estilos para telas maiores que mobile */
        .header-wrap{ grid-template-columns: auto 1fr; }
        .footerbar {
            display:flex; flex-wrap: wrap; justify-content: flex-end;
            grid-template-columns: unset; gap:8px;
        }
        .footerbar button { width: auto; }
    }
    @media (max-width:640px){
      .header-wrap{grid-template-columns:1fr;}
      .toolbar{flex-direction: column; align-items: stretch;}
      .toolbar input, .toolbar select, .toolbar .admin {width: 100%;}
      .toolbar .admin button {width: 100%;}
      #search{order: -1;}
      .grid{grid-template-columns:1fr}
      form.add-item{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-wrap">
      <div class="tabs">
        <button class="tab active" data-view="producao">Produ√ß√£o</button>
        <button class="tab" data-view="compras">Compras</button>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Buscar item‚Ä¶" />
        <select id="filter">
          <option value="TODOS">Todos</option>
          <option value="OK">OK</option>
          <option value="ALERTA">‚ö† alerta</option>
          <option value="FALTA">‚ùå falta</option>
        </select>
        <button id="exportCsv" class="ghost icon-btn" title="Exportar CSV (lista de compras)">üì§</button>
        <button id="refresh" class="ghost">Recarregar</button>
        <div class="admin">
          <span id="adminBadge" class="badge">Gestor</span>
          <button id="adminBtn" class="ghost">Entrar como Gestor</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <form class="add-item" id="addForm" style="display:none">
      <input id="nome" placeholder="Nome do item" />
      <input id="categoria" placeholder="Categoria" />
      <input id="unidade" placeholder="Unidade (kg, un, pct‚Ä¶)" />
      <input id="parMin" type="number" min="0" placeholder="Par m√≠n." />
      <button type="submit" class="primary">Adicionar</button>
    </form>
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Nenhum item encontrado.</div>
  </div>

  <div class="footerbar hidden"> <!-- Inicia escondido -->
    <button id="markOk">Marcar selecionados como OK</button>
    <button id="markWarn">Marcar selecionados como ‚ö† Alerta</button>
    <button id="markBad">Marcar selecionados como ‚ùå Falta</button>
    <button id="save" class="primary">Salvar altera√ß√µes</button>
  </div>

  <script type="module">
    // ================================== JAVASCRIPT ATUALIZADO ==================================
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://slrjqqzzxxpywquphvjz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscmpxcXp6eHhweXdxdXBodmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTYyMjksImV4cCI6MjA3MDI3MjIyOX0.JuzZMOC2X4NQUXeVdYBoQDY5pN-2O2igPK0zjNdcjcU';
    const GESTOR_PIN = '3461';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentView = 'producao', allItems = [], filtered = [], staged = new Map(), selected = new Set(), isGestor = !!localStorage.getItem('rin_is_gestor');

    const $header = document.querySelector('header');
    const $footerbar = document.querySelector('.footerbar');
    const $tabs = document.querySelectorAll('.tab');
    const $search = document.getElementById('search');
    const $filter = document.getElementById('filter');
    const $refresh = document.getElementById('refresh');
    const $list = document.getElementById('list');
    const $empty = document.getElementById('empty');
    const $addForm = document.getElementById('addForm');
    const $nome = document.getElementById('nome');
    const $categoria = document.getElementById('categoria');
    const $unidade = document.getElementById('unidade');
    const $parMin = document.getElementById('parMin');
    const $markOk = document.getElementById('markOk');
    const $markWarn = document.getElementById('markWarn');
    const $markBad = document.getElementById('markBad');
    const $save = document.getElementById('save');
    const $exportCsv = document.getElementById('exportCsv');
    const $adminBtn = document.getElementById('adminBtn');

    // ... (fun√ß√µes de helper, applyFilters, CRUD, etc. n√£o mudam muito) ...
    // Vou colar apenas as que mudaram e as novas. O resto permanece igual.

    const statusToEmoji = (s) => ({
        'OK': { label: 'OK', cls: 'ok', next: 'ALERTA' },
        'ALERTA': { label: '‚ö† Alerta', cls: 'warn', next: 'FALTA' },
        'FALTA': { label: '‚ùå Falta', cls: 'bad', next: 'OK' }
    }[s] || { label: s, cls: '', next: 'OK' });

    function notify(msg) { /* ...sem altera√ß√£o... */ }
    function normalize(str) { /* ...sem altera√ß√£o... */ }
    function updateGestorUI() { /* ...sem altera√ß√£o... */ }
    function applyFilters() { /* ...sem altera√ß√£o... */ }
    async function fetchItems() { /* ...sem altera√ß√£o... */ }
    async function addItem(payload) { /* ...sem altera√ß√£o... */ }
    async function saveStaged() { /* ...sem altera√ß√£o, mas agora tamb√©m esconde o footer */
        if (staged.size === 0) return;
        $save.disabled = true; $save.textContent = 'Salvando‚Ä¶';
        try {
            const ops = Array.from(staged.entries()).map(([id, patch]) => supabase.from('itens').update(patch).eq('id', id));
            await Promise.all(ops);
            await fetchItems();
            staged.clear();
            selected.clear();
            updateFooterVisibility(); // Esconde o rodap√©
            notify('Altera√ß√µes salvas');
        } catch (e) {
            console.error('Erro inesperado no save:', e); alert('Erro inesperado ao salvar.');
        } finally {
            updateSaveButton();
        }
    }
    function toCsv(rows){ /* ...sem altera√ß√£o... */ }
    function download(filename, text){ /* ...sem altera√ß√£o... */ }
    function exportCsv(){ /* ...sem altera√ß√£o... */ }


    // ================== NOVAS FUN√á√ïES E FUN√á√ïES MODIFICADAS ==================

    function updateFooterVisibility() {
        const shouldBeVisible = staged.size > 0 || selected.size > 0;
        $footerbar.classList.toggle('hidden', !shouldBeVisible);
    }
    
    function updateSaveButton() {
        const n = staged.size;
        $save.textContent = n ? `Salvar altera√ß√µes (${n})` : 'Salvar altera√ß√µes';
        $save.disabled = n === 0;
        updateFooterVisibility(); // Atualiza a visibilidade do rodap√© tamb√©m
    }
    
    function render() {
        applyFilters();
        $list.innerHTML = '';
        if (filtered.length === 0) { $empty.style.display = 'block'; return; }
        $empty.style.display = 'none';

        for (const item of filtered) {
            const effectiveStatus = staged.get(item.id)?.status || item.status;
            const s = statusToEmoji(effectiveStatus);
            const card = document.createElement('div');
            card.className = 'card';
            card.classList.toggle('selected', selected.has(item.id));

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selected.has(item.id);
            checkbox.onchange = (e) => {
                e.target.checked ? selected.add(item.id) : selected.delete(item.id);
                card.classList.toggle('selected', e.target.checked);
                updateFooterVisibility(); // Mostra o rodap√© ao selecionar
            };

            const pill = document.createElement('span');
            pill.className = `pill ${s.cls}`;
            pill.textContent = s.label;
            pill.onclick = () => stageStatus(item.id, s.next);
            
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div class="name">${item.nome}</div>
                </div>
                <div class="meta">
                  <span>${item.categoria||'‚Äì'}</span> ‚Ä¢ <span>${item.unidade||'‚Äì'}</span> ‚Ä¢ <span>par m√≠n.: ${item.parMin??'‚Äì'}</span>
                </div>
                <div class="status"></div>
            `;
            card.querySelector('.status').appendChild(pill);
            card.querySelector('.name').after(checkbox);
            $list.appendChild(card);
        }
    }

    function stageStatus(id, status) {
        staged.set(id, { ...staged.get(id), status });
        updateSaveButton(); // Isso j√° chama updateFooterVisibility
        render();
    }

    function bulkStage(status) {
        if (selected.size === 0) { notify('Nenhum item selecionado!'); return; }
        for (const id of selected) stageStatus(id, status);
    }

    // ================== L√ìGICA DE EVENTOS (com adi√ß√µes) ==================

    // AUTO-HIDE HEADER
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', () => {
        if (window.innerWidth > 640) return; // S√≥ aplica no mobile
        const currentScrollY = window.scrollY;
        if (currentScrollY > lastScrollY && currentScrollY > 60) {
            $header.classList.add('hidden');
        } else {
            $header.classList.remove('hidden');
        }
        lastScrollY = currentScrollY;
    });

    // EVENT LISTENERS EXISTENTES
    $tabs.forEach(tab => tab.addEventListener('click', () => { /* ...sem altera√ß√£o... */ }));
    $search?.addEventListener('input', render);
    $filter?.addEventListener('change', render);
    $refresh?.addEventListener('click', fetchItems);
    $markOk.addEventListener('click', () => bulkStage('OK'));
    $markWarn.addEventListener('click', () => bulkStage('ALERTA'));
    $markBad.addEventListener('click', () => bulkStage('FALTA'));
    $save.addEventListener('click', saveStaged);
    $exportCsv.addEventListener('click', exportCsv);
    $addForm?.addEventListener('submit', async (e) => { /* ...sem altera√ß√£o... */ });
    $adminBtn?.addEventListener('click', () => { /* ...sem altera√ß√£o... */ });

    // BOOT
    updateGestorUI();
    updateSaveButton(); // Isso j√° esconde o footer inicialmente
    fetchItems();
  </script>
</body>
</html>
