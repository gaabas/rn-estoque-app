<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RIN – Checagem de Estoque</title>
  
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#475569;
      --card:#fff; --border:#e2e8f0; --shadow:0 6px 20px rgba(2,6,23,.06);
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:14px; --primary-color: #4f46e5;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border); padding:10px 12px;
    }
    .header-wrap{
      display:flex; gap:12px; align-items: center;
      max-width:1200px; margin:0 auto;
    }
    .header-main-content {
      flex-grow: 1; display:flex; flex-direction: column; gap: 8px;
    }
    .header-actions {
      flex-shrink: 0;
    }
    .tabs{display:flex;gap:8px;}
    .tab{padding:8px 12px;border-radius:10px; background:#fff;border:1px solid var(--border);cursor:pointer;}
    .tab.active{background:#eef2ff; border-color:#c7d2fe; color:var(--primary-color); font-weight:600;}
    .toolbar{display:flex; gap:8px;}
    .toolbar input, .toolbar select{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:1rem;}
    .icon-btn {
      background:transparent; border:none; padding:8px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color: var(--muted);
    }
    .icon-btn:hover { color: var(--text); background: #f1f5f9; border-radius: 50%;}
    .icon-btn svg { width: 24px; height: 24px; }
    
    /* Controle de visibilidade dos elementos do header */
    #selection-header-content { display: none; }
    body.selection-mode .header-main-content,
    body.selection-mode #edit-btn {
        display: none;
    }
    body.selection-mode #selection-header-content {
        display: flex;
        flex-grow: 1;
        align-items: center;
        justify-content: space-between;
    }
    #selection-info { font-weight: 600; color: var(--primary-color); }

    /* ===== Conteúdo e Cards ===== */
    .container{padding:12px 12px 24px; max-width:1200px; margin:0 auto;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{
      background:var(--card);border:2px solid var(--border);
      border-radius:var(--radius);padding:12px;
      display:flex; gap:8px; box-shadow:var(--shadow); cursor:pointer;
      transition: border-color .2s, box-shadow .2s;
    }
    .item-checkbox { display: none; margin-top: 4px; }
    body.selection-mode .item-checkbox { display: block; }
    body.selection-mode .card { cursor: pointer; }
    .card.selected { border-color: var(--primary-color); }
    .item-details { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:12px;}
    .pill{
      padding:4px 10px;border-radius:999px;font-size:12px; font-weight: 500;
      border:1px solid; align-self: flex-start;
    }
    .pill.ok{border-color:#86efac; color:#065f46; background:rgba(22,163,74,.10);}
    .pill.warn{border-color:#fed7aa; color:#7c2d12; background:rgba(217,119,6,.12);}
    .pill.bad{border-color:#fecaca; color:#7f1d1d; background:rgba(220,38,38,.10);}

    /* ===== Rodapé Condicional ===== */
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index: 20;
      background:rgba(255,255,255,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      box-shadow:0 -6px 20px rgba(2,6,23,.06);
      transition: transform 0.3s ease-in-out;
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
      transform: translateY(100%); /* Começa escondido */
    }
    body.selection-mode .footerbar {
        transform: translateY(0);
    }
    .footerbar button { grid-column: span 1; }
    #save { grid-column: 1 / -1; }

    /* Estilo do botão de salvar com spinner */
    button {
        cursor:pointer;border-radius:10px;border:1px solid var(--border);
        background:#f8fafc;color:var(--text);padding:12px 10px;font-size:1rem;
        position: relative; transition: background .2s;
    }
    button.primary{background:var(--primary-color);color:#fff; border-color:var(--primary-color); font-weight:600;}
    button:disabled { background: #e2e8f0; color: var(--muted); cursor: not-allowed; }
    button.saving .btn-text { visibility: hidden; }
    button.saving::after {
        content: ''; display: block;
        position: absolute; top: 50%; left: 50%;
        width: 20px; height: 20px;
        margin-top: -10px; margin-left: -10px;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.5);
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Outros */
    .empty{color:#64748b;font-style:italic;padding:24px 0; text-align:center;}
  </style>
</head>
<body class=""> <!-- A classe 'selection-mode' será adicionada aqui via JS -->
  
  <header>
    <div class="header-wrap">
      <!-- Conteúdo Padrão do Header -->
      <div class="header-main-content" id="default-header-content">
        <div class="tabs">
          <button class="tab active" data-view="producao">Produção</button>
          <button class="tab" data-view="compras">Compras</button>
        </div>
        <div class="toolbar">
          <input id="search" type="search" placeholder="Buscar item…" style="width:100%;" />
        </div>
      </div>
      
      <!-- Conteúdo do Header em Modo de Seleção -->
      <div id="selection-header-content">
        <span id="selection-info"></span>
        <button id="select-all-btn" class="icon-btn" title="Selecionar Todos">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 5V2a1 1 0 0 1 1-1h13a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-3v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h3zm1-3v11H4V8a1 1 0 0 1 .117-.458L4 7.5V6h11V2H8zm10.445 4.105L14.5 10.05l-1.945-1.945-1.414 1.414L14.5 12.879l4.359-4.359-1.414-1.414zM15 5h3v3h-3V5z"/></svg>
        </button>
      </div>
      
      <!-- Botões de Ação do Header (sempre visíveis) -->
      <div class="header-actions">
        <button id="edit-btn" class="icon-btn" title="Editar Itens">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.757 3.243a1 1 0 0 1 1.414 0l2.586 2.586a1 1 0 0 1 0 1.414l-12 12a1 1 0 0 1-.707.293H4a1 1 0 0 1-1-1v-3.586a1 1 0 0 1 .293-.707l12-12zM18.172 6.071L16 3.899l-9.9 9.9V16h2.201l9.9-9.9z"/></svg>
        </button>
        <button id="done-btn" class="icon-btn" title="Concluir Edição" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"/></svg>
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Nenhum item encontrado.</div>
  </div>

  <div class="footerbar">
    <button id="markOk"><span class="btn-text">Marcar como OK</span></button>
    <button id="markWarn"><span class="btn-text">Marcar como Alerta</span></button>
    <button id="markBad"><span class="btn-text">Marcar como Falta</span></button>
    <button id="save" class="primary"><span class="btn-text">Salvar Alterações</span></button>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ====== CONFIG E ESTADO INICIAL =========================================================
    const SUPABASE_URL = 'https://slrjqqzzxxpywquphvjz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscmpxcXp6eHhweXdxdXBodmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTYyMjksImV4cCI6MjA3MDI3MjIyOX0.JuzZMOC2X4NQUXeVdYBoQDY5pN-2O2igPK0zjNdcjcU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let allItems = [], filtered = [], staged = new Map(), selected = new Set(), currentView = 'producao';

    // ====== ELEMENTOS DO DOM ===============================================================
    const $body = document.body;
    const $list = document.getElementById('list');
    const $search = document.getElementById('search');
    const $empty = document.getElementById('empty');
    const $tabs = document.querySelectorAll('.tab');
    
    // Controles do Header
    const $editBtn = document.getElementById('edit-btn');
    const $doneBtn = document.getElementById('done-btn');
    const $selectAllBtn = document.getElementById('select-all-btn');
    const $selectionInfo = document.getElementById('selection-info');
    
    // Controles do Footer
    const $markOk = document.getElementById('markOk');
    const $markWarn = document.getElementById('markWarn');
    const $markBad = document.getElementById('markBad');
    const $save = document.getElementById('save');

    // ====== LÓGICA DO MODO DE SELEÇÃO =====================================================
    function setSelectionMode(isActive) {
      $body.classList.toggle('selection-mode', isActive);
      $editBtn.style.display = isActive ? 'none' : 'flex';
      $doneBtn.style.display = isActive ? 'flex' : 'none';

      if (!isActive) {
        selected.clear();
      }
      updateSelectionHeader();
      render();
    }
    
    function updateSelectionHeader() {
        const count = selected.size;
        if (count === 0) {
            $selectionInfo.textContent = 'Selecione os itens';
        } else {
            $selectionInfo.textContent = `${count} ${count === 1 ? 'item selecionado' : 'itens selecionados'}`;
        }
    }

    // ====== RENDERIZAÇÃO E HELPERS ==========================================================
    const statusInfo = (s) => ({
        'OK': { text: 'OK', cls: 'ok' },
        'ALERTA': { text: 'Alerta', cls: 'warn' },
        'FALTA': { text: 'Falta', cls: 'bad' }
    }[s] || { text: s, cls: '' });

    function render() {
      // Filtros (não precisam mudar)
      const q = ($search.value || '').toLowerCase();
      filtered = allItems.filter(item => {
          const inView = (currentView === 'compras') ? item.status !== 'OK' : true;
          const matchesSearch = !q || item.nome.toLowerCase().includes(q);
          return inView && matchesSearch;
      });

      $list.innerHTML = '';
      $empty.style.display = filtered.length === 0 ? 'block' : 'none';

      for (const item of filtered) {
        const effectiveStatus = staged.get(item.id)?.status || item.status;
        const s = statusInfo(effectiveStatus);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.classList.toggle('selected', selected.has(item.id));
        
        card.innerHTML = `
          <input type="checkbox" class="item-checkbox">
          <div class="item-details">
            <div class="name"></div>
            <div class="meta"></div>
            <div class="pill ${s.cls}">${s.text}</div>
          </div>
        `;

        card.querySelector('.name').textContent = item.nome;
        card.querySelector('.meta').textContent = `${item.categoria || '–'} • ${item.unidade || '–'} • par mín.: ${item.parMin ?? '–'}`;
        
        const checkbox = card.querySelector('.item-checkbox');
        checkbox.checked = selected.has(item.id);

        const toggleSelection = () => {
            selected.has(item.id) ? selected.delete(item.id) : selected.add(item.id);
            checkbox.checked = selected.has(item.id);
            card.classList.toggle('selected', selected.has(item.id));
            updateSelectionHeader();
        };

        card.addEventListener('click', (e) => {
            if ($body.classList.contains('selection-mode')) {
                toggleSelection();
            }
        });
        
        $list.appendChild(card);
      }
    }
    
    // ====== AÇÕES E BANCO DE DADOS ========================================================
    function bulkStage(newStatus) {
        if(selected.size === 0) return;
        selected.forEach(id => staged.set(id, { status: newStatus }));
        render(); // Re-renderiza para mostrar as pílulas atualizadas
        updateSaveButtonState();
    }
    
    function updateSaveButtonState() {
        $save.disabled = staged.size === 0;
    }

    async function saveStaged() {
      if (staged.size === 0) return;
      
      $save.classList.add('saving');
      $save.disabled = true;

      try {
        const ops = Array.from(staged.entries()).map(([id, patch]) => 
          supabase.from('itens').update(patch).eq('id', id)
        );
        await Promise.all(ops);
        
        staged.clear();
        setSelectionMode(false); // Sai do modo de seleção e limpa `selected`
        await fetchItems(); // Busca dados atualizados
      } catch (e) {
        console.error('Erro ao salvar:', e);
        alert('Ocorreu um erro ao salvar as alterações.');
      } finally {
        $save.classList.remove('saving');
        updateSaveButtonState();
      }
    }

    async function fetchItems() {
      const { data, error } = await supabase.from('itens').select('*').order('nome');
      if (error) { console.error(error); return; }
      allItems = data || [];
      render();
    }

    // ====== EVENT LISTENERS ===============================================================
    $editBtn.addEventListener('click', () => setSelectionMode(true));
    $doneBtn.addEventListener('click', () => setSelectionMode(false));
    
    $selectAllBtn.addEventListener('click', () => {
        const allFilteredIds = filtered.map(item => item.id);
        const allSelected = a
