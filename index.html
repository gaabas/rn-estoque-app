<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RIN – Checagem de Estoque</title>
  
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#475569;
      --card:#fff; --border:#e2e8f0; --shadow:0 6px 20px rgba(2,6,23,.06);
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:14px; --primary-color: #4f46e5;
    }
    *{box-sizing:border-box}
    html { height: 100%; }
    body{
      margin:0; font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent;
      min-height: 100%;
    }
    body.modal-open { overflow: hidden; }

    /* ===== Header ===== */
    header{ position:sticky; top:0; z-index:10; background:rgba(255,255,255,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-bottom:1px solid var(--border); padding:10px 12px; }
    .header-wrap{ display:flex; gap:12px; align-items: center; max-width:1200px; margin:0 auto; }
    .header-main-content { flex-grow: 1; display:flex; flex-direction: column; gap: 8px; }
    .header-actions { flex-shrink: 0; }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding:8px 12px;border-radius:10px; background:#fff;border:1px solid var(--border);cursor:pointer; }
    .tab.active{ background:#eef2ff; border-color:#c7d2fe; color:var(--primary-color); font-weight:600; }
    .toolbar input{ background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:1rem; width: 100%; }
    .icon-btn { background:transparent; border:none; padding:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; color: var(--muted); }
    .icon-btn:hover { color: var(--text); background: #f1f5f9; border-radius: 50%;}
    .icon-btn svg { width: 24px; height: 24px; }
    #selection-header-content { display: none; }
    body.selection-mode .header-main-content, body.selection-mode #shopping-mode-btn { display: none; }
    body.selection-mode #selection-header-content { display: flex; flex-grow: 1; align-items: center; justify-content: space-between; }
    #selection-info { font-weight: 600; color: var(--primary-color); }

    /* ===== Conteúdo e Cards ===== */
    .container{ padding:12px 12px 120px; max-width:1200px; margin:0 auto; }
    .category-header { display: flex; align-items: center; justify-content: space-between; font-size: 1.1rem; font-weight: 600; color: var(--text); margin: 24px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .category-header:first-of-type { margin-top: 0; }
    .category-checkbox { display: none; }
    body.selection-mode .category-checkbox { display: inline-block; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px; }
    .card{ background:var(--card);border:2px solid var(--border); border-radius:var(--radius);padding:12px; display:flex; gap:8px; box-shadow:var(--shadow); cursor:pointer; transition: border-color .2s, box-shadow .2s; }
    .item-checkbox { display: none; margin-top: 4px; }
    body.selection-mode .item-checkbox { display: block; }
    .card.selected { border-color: var(--primary-color); }
    .item-details { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
    .name{ font-weight:700 }
    .meta{ color:var(--muted);font-size:13px; }
    .stock-info { font-weight: 600; color: var(--text); }
    .pill{ padding:4px 10px;border-radius:999px;font-size:12px; font-weight: 500; border:1px solid; align-self: flex-start; }
    .pill.ok{ border-color:#86efac; color:#065f46; background:rgba(22,163,74,.10); }
    .pill.warn{ border-color:#fed7aa; color:#7c2d12; background:rgba(217,119,6,.12); }
    .pill.bad{ border-color:#fecaca; color:#7f1d1d; background:rgba(220,38,38,.10); }
    .pill.buy{ border-color:#c7d2fe; color:var(--primary-color); background:#eef2ff; }

    /* ===== Rodapé ===== */
    .footerbar{ position:fixed; left:0; right:0; bottom:0; z-index: 20; background:rgba(255,255,255,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-top:1px solid var(--border); padding:10px 12px calc(10px + env(safe-area-inset-bottom)); box-shadow:0 -6px 20px rgba(2,6,23,.06); transition: transform 0.3s ease-in-out; transform: translateY(100%); }
    .footerbar.visible { transform: translateY(0); }
    .footer-content { display: grid; gap: 8px; }
    #mark-to-buy-btn { display: none; }
    body.selection-mode #mark-to-buy-btn { display: block; }
    #save-btn-wrapper { display: block; }
    body.selection-mode #save-btn-wrapper { display: none; }

    /* ===== Modal de Edição de Estoque ===== */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; transition: opacity .2s; pointer-events: none; }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }
    .modal { background: var(--bg); padding: 24px; border-radius: var(--radius); width: 100%; max-width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform .2s; }
    .modal-overlay.visible .modal { transform: scale(1); }
    .modal-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; }
    .modal-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .modal-input-group button { font-size: 1.5rem; width: 44px; height: 44px; padding: 0; line-height: 1; flex-shrink: 0; }
    #stock-input { flex-grow: 1; text-align: center; font-size: 1.8rem; font-weight: bold; padding: 10px; border: 1px solid var(--border); border-radius: 10px; width: 100%; }
    #stock-input::-webkit-outer-spin-button, #stock-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    #stock-input[type=number] { -moz-appearance: textfield; }
    .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal-actions button { flex-grow: 1; padding: 12px; }
    #modal-list-action-btn { grid-column: 1 / -1; margin-top: 10px; } /* Botão novo */

    /* ===== Outros Estilos ===== */
    button { cursor:pointer;border-radius:10px;border:1px solid var(--border); background:#f8fafc;color:var(--text);padding:12px 10px;font-size:1rem; position: relative; transition: background .2s; }
    button.primary{ background:var(--primary-color);color:#fff; border-color:var(--primary-color); font-weight:600; }
    button:disabled { background: #e2e8f0; color: var(--muted); cursor: not-allowed; }
    button.saving .btn-text { visibility: hidden; }
    button.saving::after { content: ''; display: block; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px 0 0 -10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); border-top-color: #fff; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty{ color:#64748b; font-style:italic; padding:24px 0; text-align:center; }
  </style>
</head>
<body class="">
  
  <header>
    <div class="header-wrap">
      <div class="header-main-content">
        <div class="tabs"> <button class="tab active" data-view="producao">Produção</button> <button class="tab" data-view="compras">Compras</button> </div>
        <div class="toolbar"> <input id="search" type="search" placeholder="Buscar item…"/> </div>
      </div>
      <div id="selection-header-content"> <span id="selection-info"></span></div>
      <div class="header-actions">
        <button id="shopping-mode-btn" class="icon-btn" title="Marcar itens para comprar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2a1 1 0 1 0 0 2h10a1 1 0 1 0 0-2H11ZM3 2a1 1 0 0 0-1 1v18a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H3Zm1 2h16v16H4V4Zm8 3a1 1 0 0 1 1 1v3h3a1 1 0 1 1 0 2h-3v3a1 1 0 1 1-2 0v-3H8a1 1 0 1 1 0-2h3V8a1 1 0 0 1 1-1Z"/></svg>
        </button>
        <button id="done-btn" class="icon-btn" title="Concluir" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"/></svg>
        </button>
      </div>
    </div>
  </header>

  <div class="container"> <div id="list"></div> <div id="empty" class="empty" style="display:none;">Nenhum item encontrado.</div> </div>

  <div class="footerbar" id="footerbar">
    <div class="footer-content">
      <button id="mark-to-buy-btn" class="primary"><span class="btn-text">Adicionar à Lista de Compras</span></button>
      <div id="save-btn-wrapper"> <button id="save" class="primary"><span class="btn-text">Salvar Alterações</span></button> </div>
    </div>
  </div>

  <div class="modal-overlay" id="stock-modal-overlay">
    <div class="modal" id="stock-modal">
      <div class="modal-header" id="modal-item-name"></div>
      <div class="modal-input-group"> <button id="decrement-stock">-</button> <input type="number" id="stock-input" min="0" /> <button id="increment-stock">+</button> </div>
      <div class="modal-actions">
        <button id="cancel-stock-update">Cancelar</button>
        <button id="confirm-stock-update" class="primary">Confirmar</button>
        <button id="modal-list-action-btn"></button> <!-- Botão novo -->
      </div>
    </div>
  </div>


  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ====== CONFIG E ESTADO INICIAL =========================================================
    const SUPABASE_URL = 'https://slrjqqzzxxpywquphvjz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscmpxcXp6eHhweXdxdXBodmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTYyMjksImV4cCI6MjA3MDI3MjIyOX0.JuzZMOC2X4NQUXeVdYBoQDY5pN-2O2igPK0zjNdcjcU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let allItems = [], staged = new Map(), selected = new Set(), currentView = 'producao';
    let activeModalItem = null;

    // ====== ELEMENTOS DO DOM ===============================================================
    const $body = document.body;
    const $list = document.getElementById('list');
    const $search = document.getElementById('search');
    const $tabs = document.querySelectorAll('.tab');
    const $shoppingModeBtn = document.getElementById('shopping-mode-btn');
    const $doneBtn = document.getElementById('done-btn');
    const $selectionInfo = document.getElementById('selection-info');
    const $footerbar = document.getElementById('footerbar');
    const $markToBuyBtn = document.getElementById('mark-to-buy-btn');
    const $save = document.getElementById('save');
    const $empty = document.getElementById('empty');
    const $modalOverlay = document.getElementById('stock-modal-overlay');
    const $modalItemName = document.getElementById('modal-item-name');
    const $stockInput = document.getElementById('stock-input');
    const $decrementBtn = document.getElementById('decrement-stock');
    const $incrementBtn = document.getElementById('increment-stock');
    const $cancelBtn = document.getElementById('cancel-stock-update');
    const $confirmBtn = document.getElementById('confirm-stock-update');
    const $modalListActionBtn = document.getElementById('modal-list-action-btn');

    // ====== LÓGICA DE UI ===================================================================
    function openStockModal(item) {
      activeModalItem = item;
      $modalItemName.textContent = item.nome;
      
      const stagedItem = staged.get(item.id) || {};
      const effectiveStock = stagedItem.estoqueAtual ?? item.estoqueAtual;
      const effectiveStatus = stagedItem.status || item.status;

      $stockInput.value = effectiveStock || 0;
      
      if (effectiveStatus === 'COMPRAR') {
        $modalListActionBtn.textContent = 'Remover da Lista';
        $modalListActionBtn.classList.remove('primary');
      } else {
        $modalListActionBtn.textContent = 'Adicionar à Lista';
        $modalListActionBtn.classList.add('primary');
      }

      $modalOverlay.classList.add('visible');
      $body.classList.add('modal-open');
      $stockInput.focus(); $stockInput.select();
    }
    function closeStockModal() { $modalOverlay.classList.remove('visible'); $body.classList.remove('modal-open'); activeModalItem = null; }
    
    function setSelectionMode(isActive) {
      $body.classList.toggle('selection-mode', isActive);
      $shoppingModeBtn.style.display = isActive ? 'none' : 'flex';
      $doneBtn.style.display = isActive ? 'flex' : 'none';
      if (!isActive) { selected.clear(); }
      updateUI();
      render();
    }

    function updateUI() {
      const selectionCount = selected.size;
      const stagedCount = staged.size;
      const isInSelectionMode = $body.classList.contains('selection-mode');
      
      $selectionInfo.textContent = selectionCount === 0 ? 'Selecionar Itens' : `${selectionCount} ${selectionCount === 1 ? 'item' : 'itens'} selecionado${selectionCount > 1 ? 's' : ''}`;
      
      const isFooterVisible = isInSelectionMode || stagedCount > 0;
      $footerbar.classList.toggle('visible', isFooterVisible);
      
      $save.style.display = isInSelectionMode ? 'none' : 'block';
      $markToBuyBtn.style.display = isInSelectionMode ? 'block' : 'none';
      
      $save.disabled = stagedCount === 0;
    }
    
    // ====== RENDERIZAÇÃO =================================================================
    const statusInfo = (s) => ({ 'OK': { text: 'OK', cls: 'ok' }, 'ALERTA': { text: 'Alerta', cls: 'warn' }, 'FALTA': { text: 'Falta', cls: 'bad' }, 'COMPRAR': { text: 'Comprar', cls: 'buy' } }[s] || { text: s, cls: '' });

    function render() {
      const q = ($search.value || '').toLowerCase();
      const filtered = allItems.filter(item => {
        const stagedItem = staged.get(item.id) || {};
        const effectiveStatus = stagedItem.status || item.status;
        const inView = (currentView === 'compras') ? effectiveStatus !== 'OK' : true;
        const matchesSearch = !q || item.nome.toLowerCase().includes(q) || (item.categoria || '').toLowerCase().includes(q);
        return inView && matchesSearch;
      });

      $list.innerHTML = '';
      $empty.style.display = filtered.length === 0 ? 'block' : 'none';
      if (filtered.length === 0) return;

      const groupedItems = filtered.reduce((acc, item) => {
        const category = item.categoria || 'Outros';
        if (!acc[category]) { acc[category] = []; }
        acc[category].push(item);
        return acc;
      }, {});
      
      const sortedCategories = Object.keys(groupedItems).sort((a, b) => a === 'Outros' ? 1 : b === 'Outros' ? -1 : a.localeCompare(b));
      
      for (const category of sortedCategories) {
        const header = document.createElement('h3');
        header.className = 'category-header';
        header.dataset.category = category;
        const categoryItems = groupedItems[category];
        const allInCategorySelected = categoryItems.every(item => selected.has(item.id));
        header.innerHTML = `<span>${category}</span><input type="checkbox" class="category-checkbox" ${allInCategorySelected ? 'checked' : ''}>`;
        $list.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid';
        for (const item of categoryItems) {
          const card = document.createElement('div');
          card.className = 'card';
          card.dataset.itemId = item.id;
          grid.appendChild(card);
          renderCardContent(card, item);
        }
        $list.appendChild(grid);
      }
    }

    function renderCardContent(cardElement, item) {
        const stagedItem = staged.get(item.id) || {};
        const effectiveStatus = stagedItem.status || item.status;
        const effectiveStock = stagedItem.estoqueAtual !== undefined ? stagedItem.estoqueAtual : item.estoqueAtual;
        const s = statusInfo(effectiveStatus);
        cardElement.classList.toggle('selected', selected.has(item.id));
        cardElement.innerHTML = `
          <input type="checkbox" class="item-checkbox" ${selected.has(item.id) ? 'checked' : ''}>
          <div class="item-details">
            <div class="name">${item.nome}</div>
            <div class="meta">
                <span class="stock-info">${effectiveStock} / ${item.parMin || '?'} ${item.unidade || ''}</span>
                <span> • Par Mín: ${item.parMin || '?'}</span>
            </div>
            <div class="pill ${s.cls}">${s.text}</div>
          </div>
        `;
    }
    
    // ====== AÇÕES E BANCO DE DADOS ========================================================
    function calculateStatus(estoque, parMin) {
        return (estoque <= 0) ? 'FALTA' : (estoque <= parMin) ? 'ALERTA' : 'OK';
    }

    function confirmStockUpdate() {
        if (!activeModalItem) return;
        const quantidadeAtual = parseInt($stockInput.value, 10);
        const novoStatus = calculateStatus(quantidadeAtual, activeModalItem.parMin);
        staged.set(activeModalItem.id, { ...staged.get(activeModalItem.id), estoqueAtual: quantidadeAtual, status: novoStatus });
        closeStockModal();
        render();
        updateUI();
    }
    
    function toggleListItemInModal() {
        if (!activeModalItem) return;
        const { id, estoqueAtual, parMin } = activeModalItem;
        const stagedItem = staged.get(id) || {};
        const effectiveStatus = stagedItem.status || activeModalItem.status;

        let novoStatus;
        if (effectiveStatus === 'COMPRAR') {
            novoStatus = calculateStatus(stagedItem.estoqueAtual ?? estoqueAtual, parMin); // Reverte para o status automático
        } else {
            novoStatus = 'COMPRAR';
        }
        staged.set(id, { ...stagedItem, status: novoStatus });
        closeStockModal();
        render();
        updateUI();
    }

    function markToBuy() {
      if(selected.size === 0) return;
      selected.forEach(id => { staged.set(id, { ...staged.get(id), status: 'COMPRAR' }); });
      selected.clear();
      render();
      updateUI();
      setSelectionMode(false);
    }
    
    async function saveStaged() {
      if (staged.size === 0) return;
      $save.classList.add('saving'); $save.disabled = true;
      try {
        const ops = Array.from(staged.entries()).map(([id, patch]) => supabase.from('itens').update(patch).eq('id', id));
        await Promise.all(ops);
        staged.clear();
        await fetchItems();
      } catch (e) {
        console.error('Erro ao salvar:', e); alert('Ocorreu um erro ao salvar as alterações.');
      } finally {
        $save.classList.remove('saving'); updateUI();
      }
    }

    async function fetchItems() {
      const { data, error } = await supabase.from('itens').select('*').order('nome');
      if (error) { console.error(error); return; }
      allItems = data || [];
      render();
      updateUI();
    }

    // ====== EVENT LISTENERS ===============================================================
    $list.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        const categoryHeader = e.target.closest('.category-header');

        if ($body.classList.contains('selection-mode') && categoryHeader && e.target.type === 'checkbox') {
            const category = categoryHeader.dataset.category;
            const itemsInCategory = allItems.filter(item => (item.categoria || 'Outros') === category);
            const allSelected = itemsInCategory.every(item => selected.has(item.id));
            itemsInCategory.forEach(item => allSelected ? selected.delete(item.id) : selected.add(item.id));
            render();
            updateUI();
            return;
        }

        if (card) {
            const itemId = parseInt(card.dataset.itemId, 10);
            const item = allItems.find(i => i.id === itemId);
            if(!item) return;
            if ($body.classList.contains('selection-mode')) {
                selected.has(itemId) ? selected.delete(itemId) : selected.add(itemId);
                render();
                updateUI();
            } else {
                openStockModal(item);
            }
        }
    });

    $shoppingModeBtn.addEventListener('click', () => setSelectionMode(true));
    $doneBtn.addEventListener('click', () => setSelectionMode(false));
    $tabs.forEach(tab => tab.addEventListener('click', (e) => { currentView = e.target.dataset.view; $tabs.forEach(t => t.classList.remove('active')); e.target.classList.add('active'); render(); }));
    $search.addEventListener('input', render);
    $markToBuyBtn.addEventListener('click', markToBuy);
    $save.addEventListener('click', saveStaged);
    $decrementBtn.addEventListener('click', () => { $stockInput.value = Math.max(0, parseInt($stockInput.value, 10) - 1); });
    $incrementBtn.addEventListener('click', () => { $stockInput.value = parseInt($stockInput.value, 10) + 1; });
    $cancelBtn.addEventListener('click', closeStockModal);
    $confirmBtn.addEventListener('click', confirmStockUpdate);
    $modalListActionBtn.addEventListener('click', toggleListItemInModal);
    $modalOverlay.addEventListener('click', (e) => { if (e.target === $modalOverlay) closeStockModal(); });
    
    // ====== INICIALIZAÇÃO =================================================================
    updateUI();
    fetchItems();
  </script>
</body>
</html>
