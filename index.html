<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RIN ‚Äì Checagem de Estoque</title>
  
  <style>
    /* ===== Tema e Vari√°veis Globais ===== */
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#475569;
      --card:#fff; --border:#e2e8f0; --shadow:0 6px 20px rgba(2,6,23,.06);
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:14px; --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.4);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Header (com Auto-Hide) ===== */
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,0.85);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border); padding:10px 12px;
      transition: transform 0.3s ease-in-out;
    }
    header.hidden {
      transform: translateY(-100%);
    }
    .header-wrap{
      display:grid; gap:8px; grid-template-columns:auto 1fr;
      max-width:1200px; margin:0 auto; align-items: center;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 12px;border-radius:10px; background:#fff;border:1px solid var(--border);
      cursor:pointer; transition:background .2s, border-color .2s;
    }
    .tab.active{
      background:#e0e7ff; border-color:#a5b4fc; color:#312e81; font-weight:600;
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content: flex-end;
    }
    .toolbar input, .toolbar select, .toolbar button{
      background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;
      font-size:1rem; transition:border-color .2s, box-shadow .2s;
    }
    .toolbar button.icon-btn {
        padding: 8px; line-height: 1; font-size: 1.2rem;
    }

    /* ===== Conte√∫do Principal ===== */
    .container{
      padding:12px 12px 24px; max-width:1200px; margin:0 auto;
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);padding:12px;
      display:flex;flex-direction:column;gap:8px; box-shadow:var(--shadow);
    }
    .card.selected {
        border-color: #a5b4fc; box-shadow: 0 0 0 2px #a5b4fc;
    }
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
    .status{display:flex; justify-content: flex-end; margin-top: 8px;}
    .pill{
      padding:6px 12px;border-radius:999px;font-size:12px; border:1px solid transparent;
      cursor:pointer; transition:all .2s;
    }
    .pill.ok{background:rgba(22,163,74,.10);border-color:#86efac;color:#065f46}
    .pill.warn{background:rgba(217,119,6,.12);border-color:#fed7aa;color:#7c2d12}
    .pill.bad{background:rgba(220,38,38,.10);border-color:#fecaca;color:#7f1d1d}

    /* ===== Rodap√© (Condicional) ===== */
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index: 20;
      background:rgba(255,255,255,0.85);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      box-shadow:0 -6px 20px rgba(2,6,23,.06);
      transition: transform 0.3s ease-in-out;
      display:grid; grid-template-columns:1fr; gap:8px;
    }
    .footerbar.hidden {
        transform: translateY(100%);
    }
    .footerbar button{ width: 100%; }

    /* ===== Outros Estilos ===== */
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f1f5f9;display:none}
    .empty{color:#64748b;font-style:italic;padding:24px 0; text-align:center;}
    button{cursor:pointer;border-radius:10px;border:1px solid var(--border);background:#f8fafc;color:var(--text);padding:8px 10px;font-size:1rem;}
    button.primary{background:#e0e7ff;border-color:#c7d2fe;color:#312e81; font-weight:600;}
    form.add-item{display:grid;gap:8px;margin:8px 0 16px;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    form.add-item input{background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem;}

    /* ===== Media Queries ===== */
    @media (min-width: 641px) {
        .header-wrap{ grid-template-columns: auto 1fr; }
        .footerbar {
            display:flex; flex-wrap: wrap; justify-content: flex-end;
            grid-template-columns: unset; gap:8px;
        }
        .footerbar button { width: auto; }
    }
    @media (max-width:640px){
      .header-wrap{grid-template-columns:1fr;}
      .toolbar{flex-direction: column; align-items: stretch;}
      .toolbar input, .toolbar select, .toolbar .admin {width: 100%;}
      .toolbar .admin button {width: 100%;}
      #search{order: -1;}
      .grid{grid-template-columns:1fr}
      form.add-item{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-wrap">
      <div class="tabs">
        <button class="tab active" data-view="producao">Produ√ß√£o</button>
        <button class="tab" data-view="compras">Compras</button>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Buscar item‚Ä¶" />
        <select id="filter">
          <option value="TODOS">Todos</option>
          <option value="OK">OK</option>
          <option value="ALERTA">‚ö† alerta</option>
          <option value="FALTA">‚ùå falta</option>
        </select>
        <button id="exportCsv" class="ghost icon-btn" title="Exportar CSV (lista de compras)">üì§</button>
        <button id="refresh" class="ghost">Recarregar</button>
        <div class="admin">
          <span id="adminBadge" class="badge">Gestor</span>
          <button id="adminBtn" class="ghost">Entrar como Gestor</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <form class="add-item" id="addForm" style="display:none">
      <input id="nome" placeholder="Nome do item" />
      <input id="categoria" placeholder="Categoria" />
      <input id="unidade" placeholder="Unidade (kg, un, pct‚Ä¶)" />
      <input id="parMin" type="number" min="0" placeholder="Par m√≠n." />
      <button type="submit" class="primary">Adicionar</button>
    </form>
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Nenhum item encontrado.</div>
  </div>

  <div class="footerbar hidden">
    <button id="markOk">Marcar selecionados como OK</button>
    <button id="markWarn">Marcar selecionados como ‚ö† Alerta</button>
    <button id="markBad">Marcar selecionados como ‚ùå Falta</button>
    <button id="save" class="primary">Salvar altera√ß√µes</button>
  </div>

  <script type="module">
    // ================================== JAVASCRIPT COMPLETO E CORRIGIDO ==================================
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ====== CONFIG ================================================================================
    const SUPABASE_URL = 'https://slrjqqzzxxpywquphvjz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscmpxcXp6eHhweXdxdXBodmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTYyMjksImV4cCI6MjA3MDI3MjIyOX0.JuzZMOC2X4NQUXeVdYBoQDY5pN-2O2igPK0zjNdcjcU';
    const GESTOR_PIN = '3461';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== ESTADO ================================================================================
    let currentView = 'producao', allItems = [], filtered = [], staged = new Map(), selected = new Set(), isGestor = !!localStorage.getItem('rin_is_gestor');
    let lastScrollY = window.scrollY;

    // ====== ELEMENTOS =============================================================================
    const $header = document.querySelector('header');
    const $footerbar = document.querySelector('.footerbar');
    const $tabs = document.querySelectorAll('.tab');
    const $search = document.getElementById('search');
    const $filter = document.getElementById('filter');
    const $refresh = document.getElementById('refresh');
    const $list = document.getElementById('list');
    const $empty = document.getElementById('empty');
    const $addForm = document.getElementById('addForm');
    const $nome = document.getElementById('nome');
    const $categoria = document.getElementById('categoria');
    const $unidade = document.getElementById('unidade');
    const $parMin = document.getElementById('parMin');
    const $markOk = document.getElementById('markOk');
    const $markWarn = document.getElementById('markWarn');
    const $markBad = document.getElementById('markBad');
    const $save = document.getElementById('save');
    const $exportCsv = document.getElementById('exportCsv');
    const $adminBtn = document.getElementById('adminBtn');
    const $adminBadge = document.getElementById('adminBadge');

    // ====== HELPERS ===============================================================================
    const statusToEmoji = (s) => ({
        'OK': { label: 'OK', cls: 'ok', next: 'ALERTA' },
        'ALERTA': { label: '‚ö† Alerta', cls: 'warn', next: 'FALTA' },
        'FALTA': { label: '‚ùå Falta', cls: 'bad', next: 'OK' }
    }[s] || { label: s, cls: '', next: 'OK' });
    
    function normalize(str) { return (str || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }

    function notify(msg) {
        const n = document.createElement('div');
        n.textContent = msg;
        Object.assign(n.style, {
            position: 'fixed', right: '16px', bottom: '80px', background: '#111827', color: '#f8fafc',
            border: '1px solid #1f2937', borderRadius: '10px', padding: '8px 12px', zIndex: '9999',
            boxShadow: '0 6px 20px rgba(0,0,0,.20)', opacity: '0', transform: 'translateY(10px)',
            transition: 'opacity 0.3s, transform 0.3s'
        });
        document.body.appendChild(n);
        requestAnimationFrame(() => { n.style.opacity = '1'; n.style.transform = 'translateY(0)'; });
        setTimeout(() => {
            n.style.opacity = '0'; n.style.transform = 'translateY(10px)';
            setTimeout(() => n.remove(), 300);
        }, 2000);
    }

    function updateFooterVisibility() {
        const shouldBeVisible = staged.size > 0 || selected.size > 0;
        $footerbar.classList.toggle('hidden', !shouldBeVisible);
    }
    
    function updateSaveButton() {
        const n = staged.size;
        $save.textContent = n ? `Salvar altera√ß√µes (${n})` : 'Salvar altera√ß√µes';
        $save.disabled = n === 0;
        updateFooterVisibility();
    }
    
    function updateGestorUI() {
        if ($addForm) $addForm.style.display = isGestor ? 'grid' : 'none';
        if ($adminBadge) $adminBadge.style.display = isGestor ? 'inline-block' : 'none';
        if ($adminBtn) $adminBtn.textContent = isGestor ? 'Sair do modo Gestor' : 'Entrar como Gestor';
    }

    function applyFilters() {
      const q = normalize($search?.value);
      const f = $filter?.value || 'TODOS';
      let rows = allItems.slice();
      if (currentView === 'compras') {
        rows = rows.filter(r => (staged.get(r.id)?.status || r.status) !== 'OK');
      }
      if (f !== 'TODOS') {
        rows = rows.filter(r => (staged.get(r.id)?.status || r.status) === f);
      }
      if (q) {
        rows = rows.filter(r =>
          normalize(r.nome).includes(q) ||
          normalize(r.categoria).includes(q) ||
          normalize(r.unidade).includes(q)
        );
      }
      filtered = rows;
    }
    
    function toCsv(rows) {
      const header = ['nome','categoria','unidade','parMin','status'];
      const esc = (v) => {
        const s = v == null ? '' : String(v);
        return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };
      const lines = [header.join(';')];
      for (const r of rows) {
        const status = staged.get(r.id)?.status || r.status;
        lines.push([r.nome, r.categoria || '', r.unidade || '', r.parMin ?? '', status].map(esc).join(';'));
      }
      return lines.join('\n');
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // ====== RENDER =================================================================================
    function render() {
        applyFilters();
        $list.innerHTML = '';
        if (filtered.length === 0) { $empty.style.display = 'block'; return; }
        $empty.style.display = 'none';

        for (const item of filtered) {
            const effectiveStatus = staged.get(item.id)?.status || item.status;
            const s = statusToEmoji(effectiveStatus);
            const card = document.createElement('div');
            card.className = 'card';
            card.classList.toggle('selected', selected.has(item.id));

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selected.has(item.id);
            checkbox.onchange = (e) => {
                e.target.checked ? selected.add(item.id) : selected.delete(item.id);
                card.classList.toggle('selected', e.target.checked);
                updateFooterVisibility();
            };

            const pill = document.createElement('span');
            pill.className = `pill ${s.cls}`;
            pill.textContent = s.label;
            pill.onclick = () => stageStatus(item.id, s.next);
            
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div class="name">${item.nome}</div>
                </div>
                <div class="meta">
                  <span>${item.categoria||'‚Äì'}</span> ‚Ä¢ <span>${item.unidade||'‚Äì'}</span> ‚Ä¢ <span>par m√≠n.: ${item.parMin??'‚Äì'}</span>
                </div>
                <div class="status"></div>
            `;
            card.querySelector('.status').appendChild(pill);
            card.querySelector('.name').after(checkbox);
            $list.appendChild(card);
        }
    }

    // ====== A√á√ïES ==================================================================================
    function stageStatus(id, status) {
        staged.set(id, { ...staged.get(id), status });
        updateSaveButton();
        render();
    }

    function bulkStage(status) {
        if (selected.size === 0) { notify('Nenhum item selecionado!'); return; }
        for (const id of selected) stageStatus(id, status);
    }
    
    function exportCsv() {
        let rows;
        if (currentView === 'compras') {
            rows = filtered.slice();
        } else {
            rows = (allItems).filter(r => (staged.get(r.id)?.status || r.status) !== 'OK');
        }
        if (!rows.length) { notify('Nada para exportar'); return; }
        const csv = toCsv(rows);
        const stamp = new Date().toISOString().slice(0,10);
        download(`lista-compras-${stamp}.csv`, csv);
        notify('CSV gerado');
    }

    // ====== SUPABASE - CRUD =========================================================================
    async function fetchItems() {
        const { data, error } = await supabase.from('itens').select('*').order('nome', { ascending: true });
        if (error) { console.error('Erro ao carregar itens:', error); notify('Erro ao carregar itens.'); return; }
        allItems = data || [];
        render();
    }

    async function addItem(payload) {
        const { data, error } = await supabase.from('itens').insert([payload]).select().single();
        if (error) { console.error('Erro ao adicionar item:', error); alert('N√£o consegui adicionar o item.'); return; }
        allItems.push(data);
        allItems.sort((a,b)=> a.nome.localeCompare(b.nome));
        render();
        notify('Item adicionado!');
    }

    async function saveStaged() {
        if (staged.size === 0) return;
        $save.disabled = true; $save.textContent = 'Salvando‚Ä¶';
        try {
            const ops = Array.from(staged.entries()).map(([id, patch]) => supabase.from('itens').update(patch).eq('id', id));
            await Promise.all(ops);
            await fetchItems();
            staged.clear();
            selected.clear();
            updateFooterVisibility();
            notify('Altera√ß√µes salvas');
        } catch (e) {
            console.error('Erro inesperado no save:', e); alert('Erro inesperado ao salvar.');
        } finally {
            updateSaveButton();
        }
    }
    
    // ====== EVENTOS ===============================================================================
    window.addEventListener('scroll', () => {
        if (window.innerWidth > 640) return;
        const currentScrollY = window.scrollY;
        $header.classList.toggle('hidden', currentScrollY > lastScrollY && currentScrollY > 60);
        lastScrollY = currentScrollY;
    });

    $tabs.forEach(tab => tab.addEventListener('click', () => {
        $tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentView = tab.dataset.view;
        render();
    }));

    $search.addEventListener('input', render);
    $filter.addEventListener('change', render);
    $refresh.addEventListener('click', fetchItems);
    $markOk.addEventListener('click', () => bulkStage('OK'));
    $markWarn.addEventListener('click', () => bulkStage('ALERTA'));
    $markBad.addEventListener('click', () => bulkStage('FALTA'));
    $save.addEventListener('click', saveStaged);
    $exportCsv.addEventListener('click', exportCsv);

    $addForm.addEventListener('submit', async (e) => {
        e.preventDefault(); if (!isGestor) return;
        const payload = {
            nome: ($nome.value || '').trim(), categoria: ($categoria.value || '').trim() || null,
            unidade: ($unidade.value || '').trim() || null, parMin: $parMin.value ? Number($parMin.value) : null,
            status: 'OK'
        };
        if (!payload.nome) { notify('O nome do item √© obrigat√≥rio!'); $nome.focus(); return; }
        await addItem(payload);
        $addForm.reset(); $nome.focus();
    });

    $adminBtn.addEventListener('click', () => {
        if (isGestor) {
            isGestor = false; localStorage.removeItem('rin_is_gestor');
            updateGestorUI(); notify('Saiu do modo Gestor');
            return;
        }
        const pin = prompt('PIN do Gestor:');
        if (pin === GESTOR_PIN) {
            isGestor = true; localStorage.setItem('rin_is_gestor', '1');
            updateGestorUI(); notify('Modo Gestor ativado');
        } else if (pin !== null) { alert('PIN incorreto.'); }
    });

    // ====== BOOT ==================================================================================
    updateGestorUI();
    updateSaveButton();
    fetchItems();
  </script>
</body>
</html>
